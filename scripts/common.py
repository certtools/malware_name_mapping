# -*- coding: utf-8 -*-

import csv
import os
import os.path
import sys


def find_mapping(fail: bool = True, filename='mapping.csv') -> str:
    """
    Find the mapping.csv file in the current or parent directory.

    Parameters:
        fail: If true and the mapping cannot be found an error is printed on stderr and the program
              exits with exitcode 2.
        filename: file name to search for, by default 'mapping.csv'
    """
    rel_path = os.path.join(os.path.dirname(__file__), '../')
    for path in ['./', '../', rel_path]:
        if os.path.exists(os.path.join(path, filename)):
            return os.path.join(path, filename)
    else:
        if fail is True:
            print("File 'mapping.csv' not found in '.', '..' and %r." % rel_path,
                  file=sys.stderr)
            sys.exit(2)


def load_mapping(filename: bool = None, fail: bool = True,
                 include_malpedia: bool = False) -> list:
    """
    Loads the mapping from the filename and returns it as list of lists.
    Does not load the comments column(s).

    Parameters:
        filename: The filename of the mapping. find_mapping is called if not given
        fail: Passed on to find_mapping, see the docs there.
        include_malpedia: Include malpedia data, default: False

    Returns: list of lists
    """
    if not filename:
        filename = find_mapping(fail=fail)
        if not filename and not fail:
            return
    with open(filename) as handle:
        data = [[column for column in line[:3]] for line in csv.reader(handle)
                if not line[0].startswith('#')]
    if include_malpedia:
        filename = os.path.join(os.path.dirname(filename), 'malpedia.csv')
        with open(filename) as handle:
            data.extend([[column for column in line[:3]] for line in csv.reader(handle)
                         if not line[0].startswith('#')])
    return data
